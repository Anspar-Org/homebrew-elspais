name: Publish Bottles

on:
  pull_request:
    types: [labeled]

jobs:
  publish:
    if: contains(github.event.pull_request.labels.*.name, 'pr-pull')
    runs-on: ubuntu-latest
    outputs:
      package: ${{ steps.pr-info.outputs.package }}
      version: ${{ steps.pr-info.outputs.version }}
    permissions:
      contents: write
      pull-requests: write
      actions: read
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Extract package and version from PR title
        id: pr-info
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          PACKAGE=$(echo "$TITLE" | sed -n 's/^Update \(.*\) to .*/\1/p')
          VERSION=$(echo "$TITLE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "package=${PACKAGE}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Detected: ${PACKAGE} v${VERSION}"

      - name: Get build-bottles workflow run
        id: get-run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=$(gh api \
            "repos/${{ github.repository }}/actions/workflows/build-bottles.yml/runs?head_sha=${{ github.event.pull_request.head.sha }}&status=success&per_page=1" \
            --jq '.workflow_runs[0].id')
          if [ -z "${RUN_ID}" ] || [ "${RUN_ID}" = "null" ]; then
            echo "::error::No successful build-bottles run found for SHA ${{ github.event.pull_request.head.sha }}"
            exit 1
          fi
          echo "run_id=${RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "Found build run: ${RUN_ID}"

      - name: Download bottle artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bottles-*
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.get-run.outputs.run_id }}

      - name: Setup tap repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          brew tap ${{ github.repository_owner }}/anspar
          cd "$(brew --repository ${{ github.repository_owner }}/anspar)"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git fetch origin "${{ github.event.pull_request.head.ref }}"
          git checkout "${{ github.event.pull_request.head.ref }}"

      - name: Merge bottle JSON into formula
        run: |
          ls -la *.bottle.json *.tar.gz 2>/dev/null || true
          brew bottle --merge --write --no-commit *.bottle.json

      - name: Rename bottles for GitHub Releases compatibility
        run: |
          # brew test-bot names bottles with double dash (pkg--version)
          # but Homebrew downloads expect single dash (pkg-version) with root_url
          for f in *--*.bottle.tar.gz; do
            newname="${f/--/-}"
            echo "Renaming: $f -> $newname"
            mv "$f" "$newname"
          done

      - name: Create GitHub Release and upload bottles
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE: ${{ steps.pr-info.outputs.package }}
          VERSION: ${{ steps.pr-info.outputs.version }}
        run: |
          TAG="${PACKAGE}-${VERSION}"
          gh release create "${TAG}" \
            --repo "${{ github.repository }}" \
            --title "${PACKAGE} ${VERSION}" \
            --notes "Bottles for ${PACKAGE} ${VERSION}" \
            --latest \
            2>/dev/null || echo "Release ${TAG} already exists"
          gh release upload "${TAG}" *.tar.gz \
            --repo "${{ github.repository }}" \
            --clobber

      - name: Commit updated formula and push
        env:
          PACKAGE: ${{ steps.pr-info.outputs.package }}
          VERSION: ${{ steps.pr-info.outputs.version }}
        run: |
          cd "$(brew --repository ${{ github.repository_owner }}/anspar)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/
          if ! git diff --cached --quiet; then
            git commit -m "bottle: Add bottle for ${PACKAGE} ${VERSION}"
            git push origin "${{ github.event.pull_request.head.ref }}"
          fi

      - name: Merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          for attempt in 1 2 3 4 5; do
            if gh pr merge "${PR_NUMBER}" \
                 --repo "${{ github.repository }}" \
                 --squash \
                 --delete-branch; then
              echo "PR #${PR_NUMBER} merged successfully on attempt ${attempt}"
              exit 0
            fi
            echo "Merge attempt ${attempt}/5 failed, waiting 15s..."
            sleep 15
          done
          echo "::error::Failed to merge PR #${PR_NUMBER} after 5 attempts"
          exit 1

  notify:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: [publish]
    if: always() && needs.publish.result != 'skipped'

    steps:
      - name: Build message
        id: message
        env:
          RESULT: ${{ needs.publish.result }}
          PACKAGE: ${{ needs.publish.outputs.package }}
          VERSION: ${{ needs.publish.outputs.version }}
          SERVER_URL: ${{ github.server_url }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          RUN_URL="${SERVER_URL}/${REPOSITORY}/actions/runs/${RUN_ID}"
          PKG="${PACKAGE:-unknown}"
          VER="${VERSION:-unknown}"

          if [ "$RESULT" = "success" ]; then
            MSG=":white_check_mark: *${PKG} v${VER} is now available on Homebrew*\n\n\`brew upgrade ${PKG}\` or \`brew install ${PKG}\`\n*Run:* <${RUN_URL}|View run>"
          else
            MSG=":rotating_light: *Homebrew publish failed* for ${PKG} v${VER}\n\n*Run:* <${RUN_URL}|View failed run>"
          fi

          echo "text=${MSG}" >> "$GITHUB_OUTPUT"

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_APP_OATH_TOKEN }}
          errors: true
          payload: |
            channel: "${{ secrets.SLACK_FALLBACK_CHANNEL }}"
            text: "${{ steps.message.outputs.text }}"
